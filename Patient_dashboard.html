<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Patient Dashboard - HealthPortal</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#3A86FF",
              "secondary": "#43AA8B",
              "accent": "#F94144",
              "background-light": "#F4F7FA",
              "background-dark": "#101922",
              "text-light-primary": "#212529",
              "text-light-secondary": "#6C757D",
              "text-dark-primary": "#F4F7FA",
              "text-dark-secondary": "#9DA7B2",
              "card-light": "#FFFFFF",
              "card-dark": "#1A2836",
              "border-light": "#E9ECEF",
              "border-dark": "#2C3A48",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-light-primary dark:text-dark-primary">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<header class="sticky top-0 z-50 w-full border-b border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
<div class="container mx-auto px-4">
<div class="flex h-16 items-center justify-between">
<div class="flex items-center gap-8">
<a id="app-logo-link" href="index.html" class="flex items-center gap-2 text-primary cursor-pointer">
<span class="material-symbols-outlined text-3xl">health_and_safety</span>
<h2 class="text-xl font-bold leading-tight">HealthPortal</h2>
</a>
<nav class="hidden md:flex items-center gap-6">
<a class="text-sm font-semibold text-primary" href="Patient_dashboard.html">Dashboard</a>
<a class="text-sm font-medium text-text-light-secondary dark:text-dark-secondary hover:text-primary dark:hover:text-primary" href="My_Appointments_patient.html">Appointments</a>
<a class="text-sm font-medium text-text-light-secondary dark:text-dark-secondary hover:text-primary dark:hover:text-primary" href="My_Medical_records.html">Records</a>
<a class="text-sm font-medium text-text-light-secondary dark:text-dark-secondary hover:text-primary dark:hover:text-primary" href="find_doctor.html">Find a Doctor</a>
</nav>
</div>
<div class="flex items-center gap-4">
<!-- Notification Dropdown -->
<div class="relative">
    <button id="notifications-button" class="relative flex items-center justify-center rounded-full size-10 hover:bg-primary/10 dark:hover:bg-primary/20">
        <span class="material-symbols-outlined text-text-light-secondary dark:text-dark-secondary">notifications</span>
        <div id="notification-dot" class="absolute top-2 right-2 size-2 rounded-full bg-accent ring-2 ring-background-light dark:ring-background-dark hidden"></div>
    </button>
    <!-- Dropdown Panel -->
    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-card-light dark:bg-card-dark rounded-lg shadow-xl border border-border-light dark:border-border-dark z-20">
        <div class="p-4 border-b border-border-light dark:border-border-dark">
            <h3 class="font-semibold text-text-light-primary dark:text-dark-primary">Notifications</h3>
        </div>
        <div id="notification-list" class="p-2 max-h-96 overflow-y-auto"></div>
        <div id="no-notifications-message" class="p-4 text-center text-sm text-text-light-secondary dark:text-dark-secondary hidden"><p>No new notifications.</p></div>
    </div>
</div>
<div class="flex items-center gap-2">
<div id="profile-picture" class="size-10 rounded-full bg-cover bg-center" data-alt="Profile picture"></div>
<!-- Simple dropdown for logout -->
<div class="relative group">
    <button id="logout-button" class="p-2 rounded-full hover:bg-primary/10">
        <span class="material-symbols-outlined text-text-light-secondary dark:text-dark-secondary">logout</span>
    </button>
</div>
</div>
</div>
</div>
</div>
</header>
<main class="flex-grow">
<div class="container mx-auto px-4 py-8">
<div class="mb-6">
<h1 id="welcome-message" class="text-3xl md:text-4xl font-black leading-tight tracking-tight text-text-light-primary dark:text-dark-primary">Welcome back!</h1>
<p class="text-base text-text-light-secondary dark:text-dark-secondary mt-1">Here's an overview of your health dashboard.</p>
</div>
<div class="mb-8 p-6 md:p-8 rounded-xl bg-primary/10 dark:bg-primary/20 border border-primary/20">
<div class="flex flex-col md:flex-row items-center gap-6 text-center md:text-left">
<div class="flex-shrink-0">
<span class="material-symbols-outlined text-5xl md:text-6xl text-primary">smart_toy</span>
</div>
<div class="flex-grow">
<h2 class="text-2xl font-bold text-text-light-primary dark:text-dark-primary">Feeling unwell?</h2>
<p class="text-text-light-secondary dark:text-dark-secondary mt-1 max-w-lg mx-auto md:mx-0">Use our AI Symptom Checker for a quick preliminary analysis and guidance on your next steps.</p>
</div>
<div class="flex-shrink-0 w-full md:w-auto">
<a href="AI_Symptom_checker.html" class="flex w-full items-center justify-center gap-2 rounded-lg h-12 px-6 bg-primary text-white text-base font-semibold hover:bg-primary/90 transition-colors shadow-lg shadow-primary/20">
<span class="material-symbols-outlined">auto_awesome</span>
<span>Start Symptom Check</span>
</a>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-2 space-y-8">
<div class="rounded-lg bg-card-light dark:bg-card-dark p-6 shadow-sm border border-border-light dark:border-border-dark">
<h2 class="text-xl font-bold leading-tight tracking-tight mb-4">Upcoming Appointments</h2>
<div id="appointments-list" class="space-y-4">
<!-- Template for appointments -->
<div id="appointment-template" class="hidden flex-col md:flex-row items-stretch gap-4 rounded-lg bg-background-light dark:bg-background-dark p-4 border border-border-light dark:border-border-dark">
    <div class="doctor-avatar w-full md:w-24 h-24 md:h-auto flex-shrink-0 bg-center bg-no-repeat bg-cover rounded-md"></div>
    <div class="flex flex-grow flex-col gap-1.5">
        <p class="appointment-time text-sm font-semibold text-secondary">Time</p>
        <p class="doctor-name text-lg font-bold">Doctor Name</p>
        <p class="doctor-specialization text-sm text-text-light-secondary dark:text-dark-secondary">Specialization</p>
        <div class="mt-auto pt-2">
            <a href="#" class="join-call-link flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-semibold hover:bg-primary/90 transition-colors w-full md:w-auto">
                <span class="material-symbols-outlined text-base">videocam</span>
                <span class="truncate">Join Video Call</span>
            </a>
        </div>
    </div>
</div>
<!-- End of template -->
</div>
<div id="no-appointments-message" class="text-center py-8 text-text-light-secondary dark:text-dark-secondary" style="display: none;">
    <p>You have no upcoming appointments.</p>
</div>
</div>
</div>
<div class="lg:col-span-1 space-y-8">
<div class="rounded-lg bg-card-light dark:bg-card-dark p-6 shadow-sm border border-border-light dark:border-border-dark">
<h3 class="text-xl font-bold mb-4">Quick Actions</h3>
<div class="grid grid-cols-2 gap-4">
<a class="flex flex-col items-center justify-center gap-2 p-4 rounded-lg bg-background-light dark:bg-background-dark hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors text-center" href="find_doctor.html">
<span class="material-symbols-outlined text-primary text-3xl">add_circle</span>
<p class="text-sm font-semibold">Schedule New</p>
</a>
<a class="flex flex-col items-center justify-center gap-2 p-4 rounded-lg bg-background-light dark:bg-background-dark hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors text-center" href="find_doctor.html">
<span class="material-symbols-outlined text-primary text-3xl">videocam</span>
<p class="text-sm font-semibold">Video Consult</p>
</a>
</div>
</div>
<div class="rounded-lg bg-card-light dark:bg-card-dark p-6 shadow-sm border border-border-light dark:border-border-dark">
<h3 class="text-xl font-bold mb-4">Medical Records</h3>
<div class="space-y-3">
<a id="prescriptions-link" class="group flex items-center justify-between p-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors cursor-pointer">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-secondary">description</span>
<span class="font-medium">Prescriptions</span>
</div>
<div class="flex items-center gap-2">
<span id="prescriptions-count" class="text-sm font-semibold bg-accent/10 text-accent px-2 py-1 rounded-full hidden"></span>
<span class="material-symbols-outlined text-text-light-secondary dark:text-dark-secondary text-base group-hover:translate-x-1 transition-transform">arrow_forward_ios</span>
</div>
</a>
<a id="lab-results-link" class="group flex items-center justify-between p-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors cursor-pointer">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-secondary">science</span>
<span class="font-medium">Lab Results</span>
</div>
<span class="material-symbols-outlined text-text-light-secondary dark:text-dark-secondary text-base group-hover:translate-x-1 transition-transform">arrow_forward_ios</span>
</a>
<a id="vaccinations-link" class="group flex items-center justify-between p-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors cursor-pointer">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-secondary">vaccines</span>
<span class="font-medium">Vaccinations</span>
</div>
<span class="material-symbols-outlined text-text-light-secondary dark:text-dark-secondary text-base group-hover:translate-x-1 transition-transform">arrow_forward_ios</span>
</a>
</div>
<button onclick="window.location.href='My_Medical_records.html'" class="mt-6 flex w-full items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/10 dark:bg-primary/20 text-primary text-sm font-semibold hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                            Access All Records
                            <span class="material-symbols-outlined text-base">arrow_forward</span>
</button>
</div>
</div>
</div>
</div>
</main>
</div>
<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white dark:bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-6 m-4 text-center">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-text-light-primary dark:text-dark-primary">Upload Document</h2>
            <button id="closeModalBtn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Toggle for upload type -->
        <div class="flex justify-center gap-2 mb-4">
            <button id="fileUploadOptionBtn" class="px-4 py-2 rounded-lg text-sm font-semibold bg-primary text-white">Upload File</button>
            <button id="driveLinkOptionBtn" class="px-4 py-2 rounded-lg text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">Add Drive Link</button>
        </div>

        <!-- File Upload Input -->
        <div id="fileInputContainer">
            <p class="text-text-light-secondary dark:text-dark-secondary mb-4">Please select the file you wish to upload.</p>
            <input type="file" id="fileInput" class="block w-full text-sm text-text-light-secondary
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-primary/10 file:text-primary
                hover:file:bg-primary/20
                dark:file:bg-primary/20 dark:file:text-white dark:hover:file:bg-primary/30
            ">
        </div>

        <!-- Drive Link Input -->
        <div id="driveLinkInputContainer" class="hidden">
            <p class="text-text-light-secondary dark:text-dark-secondary mb-4">Please paste the shareable Google Drive link.</p>
            <input type="url" id="driveLinkInput" placeholder="e.g., https://drive.google.com/file/d/..." class="block w-full p-3 rounded-lg border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:ring-2 focus:ring-primary">
        </div>

        <input type="hidden" id="documentTypeInput">
        <input type="hidden" id="uploadMethodInput" value="file"> <!-- Default to file upload -->

        <button id="uploadButton" class="mt-6 w-full flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-semibold hover:bg-primary/90 transition-colors">
            <span class="material-symbols-outlined text-base">upload_file</span>
            Upload
        </button>
        <p id="uploadStatus" class="mt-3 text-sm"></p>
    </div>
</div>

<!-- Firebase Scripts -->
<script type="module" src="firebase_config.js"></script>
<script type="module" src="patient_dashboard.js"></script>
<script type="module" src="patient_notifications.js"></script>
<script type="module">
   import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
    import { app, storage } from './firebase_config.js';

    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
        } else {
            currentUserId = null;
            // Optionally redirect to login if not authenticated and trying to upload
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const uploadModal = document.getElementById("uploadModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const modalTitle = document.getElementById("modal-title");
        const documentTypeInput = document.getElementById("documentTypeInput");
        const uploadStatus = document.getElementById("uploadStatus");
        const fileInput = document.getElementById('fileInput');
        const driveLinkInput = document.getElementById('driveLinkInput');
        const uploadButton = document.getElementById('uploadButton');

        // New elements for upload type toggle
        const fileUploadOptionBtn = document.getElementById('fileUploadOptionBtn');
        const driveLinkOptionBtn = document.getElementById('driveLinkOptionBtn');
        const fileInputContainer = document.getElementById('fileInputContainer');
        const driveLinkInputContainer = document.getElementById('driveLinkInputContainer');
        const uploadMethodInput = document.getElementById('uploadMethodInput');

        const prescriptionsLink = document.getElementById('prescriptions-link');
        const labResultsLink = document.getElementById('lab-results-link');
        const vaccinationsLink = document.getElementById('vaccinations-link');
        const prescriptionsCount = document.getElementById('prescriptions-count');

        function openUploadModal(type) {
            modalTitle.textContent = `Upload ${type}`;
            documentTypeInput.value = type;
            fileInput.value = ''; // Clear file input
            uploadStatus.textContent = ''; // Clear previous status
            fileInput.value = ''; // Clear file input
            driveLinkInput.value = ''; // Clear drive link input
            uploadModal.classList.remove('hidden');
            // Reset to file upload view by default when modal opens
            showFileUploadOption();
        }

        function showFileUploadOption() {
            fileInputContainer.classList.remove('hidden');
            driveLinkInputContainer.classList.add('hidden');
            fileUploadOptionBtn.classList.add('bg-primary', 'text-white');
            fileUploadOptionBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
            driveLinkOptionBtn.classList.remove('bg-primary', 'text-white');
            driveLinkOptionBtn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
            uploadMethodInput.value = 'file';
        }

        function showDriveLinkOption() {
            fileInputContainer.classList.add('hidden');
            driveLinkInputContainer.classList.remove('hidden');
            driveLinkOptionBtn.classList.add('bg-primary', 'text-white');
            driveLinkOptionBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
            fileUploadOptionBtn.classList.remove('bg-primary', 'text-white');
            fileUploadOptionBtn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');
            uploadMethodInput.value = 'link';
        }

        fileUploadOptionBtn.addEventListener('click', showFileUploadOption);
        driveLinkOptionBtn.addEventListener('click', showDriveLinkOption);

        prescriptionsLink.addEventListener('click', (e) => { e.preventDefault(); openUploadModal('Prescription'); });
        labResultsLink.addEventListener('click', (e) => { e.preventDefault(); openUploadModal('Lab Result'); });
        vaccinationsLink.addEventListener('click', (e) => { e.preventDefault(); openUploadModal('Vaccination Record'); });

        closeModalBtn.addEventListener('click', () => { uploadModal.classList.add('hidden'); });
        uploadModal.addEventListener('click', (event) => { if (event.target === uploadModal) { uploadModal.classList.add('hidden'); } });

        // Handle the actual upload logic
        uploadButton.addEventListener('click', async () => {
            if (!currentUserId) {
                uploadStatus.textContent = 'You must be logged in to upload documents.';
                uploadStatus.style.color = 'red';
                return;
            }

            const type = documentTypeInput.value;
            const uploadMethod = uploadMethodInput.value;
            uploadStatus.textContent = ''; // Clear previous status

            if (uploadMethod === 'file') {
                const selectedFile = fileInput.files[0];
                if (selectedFile) {
                    uploadStatus.textContent = `Uploading "${selectedFile.name}" as a "${type}"...`;
                    uploadStatus.style.color = '#3A86FF'; // Primary blue

                    try {
                        const storageRef = ref(storage, `medical_records/${currentUserId}/${type}/${selectedFile.name}`);
                        const uploadTask = await uploadBytes(storageRef, selectedFile);
                        const downloadURL = await getDownloadURL(uploadTask.ref);

                        await addDoc(collection(db, "medicalRecords"), {
                            userId: currentUserId,
                            documentType: type,
                            fileName: selectedFile.name,
                            fileUrl: downloadURL,
                            uploadMethod: 'file',
                            timestamp: serverTimestamp()
                        });

                        uploadStatus.textContent = `"${selectedFile.name}" uploaded successfully as "${type}"!`;
                        uploadStatus.style.color = '#43AA8B'; // Secondary green
                        fileInput.value = ''; // Clear the file input
                        // Optionally close modal or refresh a list here
                    } catch (error) {
                        console.error("Error uploading file or saving record:", error);
                        uploadStatus.textContent = `Error uploading file: ${error.message}`;
                        uploadStatus.style.color = '#F94144'; // Accent red
                    }
                } else {
                    uploadStatus.textContent = 'Please select a file to upload.';
                    uploadStatus.style.color = '#F94144'; // Accent red
                }
            } else if (uploadMethod === 'link') {
                const driveLink = driveLinkInput.value.trim();
                if (driveLink) {
                    // Basic validation for a Google Drive link
                    if (driveLink.startsWith('https://drive.google.com/')) {
                        uploadStatus.textContent = `Adding drive link "${driveLink}" as a "${type}"...`;
                        uploadStatus.style.color = '#3A86FF'; // Primary blue

                        try {
                            await addDoc(collection(db, "medicalRecords"), {
                                userId: currentUserId,
                                documentType: type,
                                fileUrl: driveLink, // Storing the link directly
                                uploadMethod: 'link',
                                timestamp: serverTimestamp()
                            });
                            uploadStatus.textContent = `Drive link added successfully as "${type}"!`;
                            uploadStatus.style.color = '#43AA8B'; // Secondary green
                            driveLinkInput.value = ''; // Clear the link input
                        } catch (error) {
                            console.error("Error saving drive link record:", error);
                            uploadStatus.textContent = `Error adding drive link: ${error.message}`;
                            uploadStatus.style.color = '#F94144'; // Accent red
                        }
                    } else {
                        uploadStatus.textContent = 'Please enter a valid Google Drive link.';
                        uploadStatus.style.color = '#F94144'; // Accent red
                    }
                } else {
                    uploadStatus.textContent = 'Please enter a Google Drive link.';
                }
            }
        });
    });
</script>
</body></html>
